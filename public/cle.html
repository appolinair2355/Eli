<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des licences – Admin</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; }
    #login { text-align: center; margin-top: 50px; }
    #licenceTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #licenceTable th, #licenceTable td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    #licenceTable th { background: #007bff; color: white; }
    .used { background: #ffeeba; }
    .expired { background: #f8d7da; }
    .available { background: #d4edda; }
  </style>
</head>
<body>
  <h1>🔑 Gestion des licences</h1>

  <!-- Formulaire mot de passe -->
  <div id="login">
    <p>Veuillez entrer le mot de passe administrateur :</p>
    <input type="password" id="adminPass" placeholder="Mot de passe">
    <button onclick="checkPassword()">Connexion</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Tableau licences (caché au début) -->
  <div id="adminPanel" style="display:none;">
    <h2>📋 Liste des licences</h2>
    <table id="licenceTable">
      <thead>
        <tr>
          <th>Licence</th>
          <th>Catégorie</th>
          <th>Statut</th>
          <th>Temps restant</th>
        </tr>
      </thead>
      <tbody id="licenceBody"></tbody>
    </table>
  </div>

  <script>
    const PASSWORD = "sossoukouam@gmail.com";

    function checkPassword() {
      const input = document.getElementById("adminPass").value;
      if (input === PASSWORD) {
        document.getElementById("login").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadLicences();
      } else {
        document.getElementById("loginError").innerText = "❌ Mot de passe incorrect";
      }
    }

    async function loadLicences() {
      try {
        const res = await fetch("/licences.json");
        const data = await res.json();
        renderLicences(data.licences);
      } catch (err) {
        console.error("Erreur chargement licences:", err);
      }
    }

    function renderLicences(licences) {
      const tbody = document.getElementById("licenceBody");
      tbody.innerHTML = "";

      licences.forEach(lic => {
        const tr = document.createElement("tr");

        // statut CSS
        let cssClass = lic.status === "available" ? "available" :
                       lic.status === "used" ? "used" : "expired";

        // temps restant
        let remaining = "-";
        if (lic.status === "used") {
          const endTime = lic.startTime + lic.durationMs;
          const diff = endTime - Date.now();
          if (diff > 0) {
            remaining = formatTime(diff);
            startCountdown(tr, lic.startTime, lic.durationMs);
          } else {
            remaining = "Expirée";
          }
        }

        tr.className = cssClass;
        tr.innerHTML = `
          <td>${lic.code}</td>
          <td>${lic.category}</td>
          <td>${lic.status}</td>
          <td class="remaining">${remaining}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      let h = Math.floor(totalSeconds / 3600);
      let m = Math.floor((totalSeconds % 3600) / 60);
      let s = totalSeconds % 60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    function startCountdown(row, startTime, durationMs) {
      const td = row.querySelector(".remaining");
      const interval = setInterval(() => {
        const endTime = startTime + durationMs;
        const diff = endTime - Date.now();
        if (diff <= 0) {
          clearInterval(interval);
          td.innerText = "Expirée";
          row.className = "expired";
        } else {
          td.innerText = formatTime(diff);
        }
      }, 1000);
    }
  </script>
</body>
</html>
