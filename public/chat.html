<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kouam√© AI ‚Äì G√©n√©rateur d‚ÄôHistoires</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    textarea, input { width: 100%; margin: 5px 0; padding: 10px; }
    button { margin: 5px; padding: 10px 20px; cursor: pointer; }
    #result { background: #fff; padding: 15px; margin-top: 20px; border-radius: 8px; min-height: 150px; }
    .signature { margin-top: 15px; font-size: 0.9em; color: #666; }
    #history { margin-top: 20px; }
    .history-item { background: #eee; padding: 8px; margin: 5px 0; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üìñ Kouam√© AI ‚Äì G√©n√©rateur d‚ÄôHistoires</h1>

  <label>Titre :</label>
  <input id="title" type="text" placeholder="Titre de l‚Äôhistoire">

  <label>√âpisode :</label>
  <input id="episode" type="number" value="1" min="1">

  <label>Auteur :</label>
  <input id="author" type="text" placeholder="Votre nom">

  <label>R√©sum√© :</label>
  <textarea id="summary" placeholder="R√©sum√© de d√©part"></textarea>

  <label>Consignes :</label>
  <textarea id="consignes" placeholder="Ex : plus de suspense, d√©veloppe le dialogue..."></textarea>

  <label>Nombre minimum de mots :</label>
  <input id="minWords" type="number" value="400" min="100">

  <div>
    <button onclick="generateStory()">G√©n√©rer</button>
    <button onclick="nextEpisode()">Suivant</button>
    <button onclick="modifyStory()">Modifier</button>
    <button onclick="generateAllEpisodes()">G√©n√©rer 15 √©pisodes auto</button>
  </div>

  <div id="result"></div>

  <h2>üìö Historique</h2>
  <div id="history"></div>

<script>
let storyHistory = [];
let lastStory = "";
let verrouille = false;

// --- G√©n√©ration normale ---
async function generateStory() {    
  const title = document.getElementById("title").value.trim();    
  const episode = document.getElementById("episode").value.trim();    
  const author = document.getElementById("author").value.trim();    
  const summary = document.getElementById("summary").value.trim();    
  const consignes = document.getElementById("consignes").value.trim();    
  const minWords = document.getElementById("minWords").value.trim();    

  if (!title || !episode || !author) { 
    alert("Veuillez remplir Titre, √âpisode et Auteur !"); 
    return; 
  }    

  let context = `Titre : ${title}\n√âpisode ${episode}\nAuteur : ${author}\n\nR√©sum√© initial : ${summary}\n\n`;    

  if (storyHistory.length > 0) {    
    context += `Texte complet des √©pisodes pr√©c√©dents :\n`;    
    storyHistory.forEach(e => {    
      context += `--- √âpisode ${e.episode} ---\n${e.fullText}\n\n`;    
    });    
  }    

  if (consignes) context += `Consignes pour cet √©pisode : ${consignes}\n`;    
  if (minWords) context += `‚ö†Ô∏è Longueur stricte : minimum ${minWords} mots.\n`;    

  context += `
‚ö†Ô∏è R√®gles de narration :
- Chaque √©pisode doit ABSOLUMENT faire avancer l‚Äôhistoire.
- Dialogues vivants et naturels entre les personnages (avec "‚Äî" devant les r√©pliques).
- Actions dynamiques et descriptions d√©taill√©es des lieux.
- Portraits physiques et psychologiques des personnages.
- Int√©grer des proverbes, des le√ßons de vie et parfois des po√®mes d‚Äôamour.
- Respect STRICT du nombre de mots demand√©.
- Ne pas √©crire de titres ni de num√©ros d‚Äô√©pisode, seulement le r√©cit.
- Style narratif immersif, riche, fluide et captivant.
`;

  resultDiv.innerHTML = "<em>‚è≥ Kouam√© AI √©crit l‚Äôhistoire‚Ä¶</em>";    

  const res = await fetch("/ask", {    
    method: "POST",    
    headers: { "Content-Type": "application/json" },    
    body: JSON.stringify({ data: "", question: context })    
  });    

  const reader = res.body.getReader();    
  const decoder = new TextDecoder();    
  let story = "";    

  while (true) {    
    const { done, value } = await reader.read();    
    if (done) break;    
    story += decoder.decode(value, { stream: true });    
    resultDiv.textContent = story;    
  }    

  lastStory = story.trim();    

  const finalContent = `
    <h2>${title}</h2>
    <h3>√âpisode ${episode}</h3>
    <div>${lastStory}</div>
    <div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>
  `;    

  resultDiv.innerHTML = finalContent;    

  storyHistory.push({ 
    title, 
    episode, 
    preview: lastStory.slice(0,100)+"...", 
    content: finalContent, 
    fullText: lastStory 
  });    

  renderHistory(); 

  // --- ‚ö†Ô∏è Vider & verrouiller apr√®s le premier √©pisode uniquement ---
  if (episode === "1") {
    setTimeout(() => {
      resultDiv.innerHTML = "<em>√âpisode 1 g√©n√©r√©. Cliquez sur 'Suivant' pour continuer l‚Äôhistoire.</em>";
      verrouille = true;
    }, 3000);
  }
}

// --- Passer √† l‚Äô√©pisode suivant ---
function nextEpisode() {
  if (!verrouille && storyHistory.length === 0) {
    alert("G√©n√©rez d‚Äôabord le premier √©pisode !");
    return;
  }
  let ep = parseInt(document.getElementById("episode").value);
  document.getElementById("episode").value = ep + 1;
  verrouille = false;
  generateStory();
}

// --- Modification d‚Äôun √©pisode ---
function modifyStory() {
  if (!lastStory) {
    alert("Aucun texte √† modifier !");
    return;
  }
  const newConsignes = prompt("Entrez vos instructions pour modifier cet √©pisode :");
  if (!newConsignes) return;

  document.getElementById("consignes").value = newConsignes;
  generateStory();
}

// --- G√©n√©rer 15 √©pisodes d‚Äôun coup ---
async function generateAllEpisodes() {
  let totalEpisodes = 15;
  let minWords = document.getElementById("minWords").value.trim();
  for (let i = 1; i <= totalEpisodes; i++) {
    document.getElementById("episode").value = i;
    await generateStory();
    await new Promise(r => setTimeout(r, 4000));
  }
}

// --- Historique ---
function renderHistory() {
  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = "";
  storyHistory.forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.textContent = `√âpisode ${item.episode} : ${item.preview}`;
    div.onclick = () => {
      document.getElementById("result").innerHTML = item.content;
      lastStory = item.fullText;
    };
    historyDiv.appendChild(div);
  });
}
</script>
</body>
</html>
