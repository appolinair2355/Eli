<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kouam√© AI ‚Äì G√©n√©rateur d‚Äôhistoires</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; }
    h1 { text-align:center; color:#333; }
    .form-container, .result-container, .history-container {
      background:#fff; padding:20px; margin-bottom:20px; border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, textarea { width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc; }
    button {
      margin-top:15px; padding:10px 15px; background:#007bff; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
    button:hover { background:#0056b3; }
    .story { white-space:pre-wrap; margin-top:20px; }
    .signature { margin-top:20px; font-style:italic; color:#555; }
    .history-item { cursor:pointer; padding:5px; border-bottom:1px solid #ddd; }
    .history-item:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>‚úçÔ∏è Kouam√© AI ‚Äì G√©n√©rateur d‚Äôhistoires</h1>

  <div class="form-container">
    <label for="title">Titre de l'histoire :</label>
    <input type="text" id="title"/>

    <label for="episode">Num√©ro de l'√©pisode :</label>
    <input type="number" id="episode" value="1" min="1"/>

    <label for="author">Nom de l'auteur :</label>
    <input type="text" id="author"/>

    <label for="summary">R√©sum√© de d√©part (pour l‚Äô√©pisode 1 uniquement) :</label>
    <textarea id="summary" rows="3"></textarea>

    <label for="consignes">Consignes sp√©cifiques (optionnel) :</label>
    <textarea id="consignes" rows="3"></textarea>

    <label for="minWords">Nombre minimum de mots (optionnel) :</label>
    <input type="number" id="minWords"/>

    <button onclick="generateStory()">‚ú® G√©n√©rer</button>
    <button onclick="nextEpisode()">‚è≠Ô∏è √âpisode suivant</button>
    <button onclick="exportPDF()">üìÑ Exporter en PDF</button>
  </div>

  <div class="result-container">
    <h2>R√©sultat :</h2>
    <div id="result" class="story"></div>
  </div>

  <div class="history-container">
    <h2>Historique des √©pisodes</h2>
    <div id="history"></div>
  </div>

  <script>
    const resultDiv = document.getElementById("result");
    const historyDiv = document.getElementById("history");
    let storyHistory = [];
    let lastStory = "";

    // ---------- Formatage ----------
    function formatStoryText(text) {
      return text
        .replace(/\n{3,}/g, "\n\n")
        .replace(/- (.+)/g, "<br>‚Äì $1");
    }

    // ---------- G√©n√©ration ----------
    async function generateStory() {  
      const title = document.getElementById("title").value.trim();  
      const episode = document.getElementById("episode").value.trim();  
      const author = document.getElementById("author").value.trim();  
      const summary = document.getElementById("summary").value.trim();  
      const consignes = document.getElementById("consignes").value.trim();  
      const minWords = document.getElementById("minWords").value.trim();  

      if (!title || !episode || !author) {  
        alert("Veuillez remplir Titre, √âpisode et Auteur !");  
        return;  
      }  

      // üîπ Construit le contexte global
      let context = `Titre : ${title}\n√âpisode ${episode}\nAuteur : ${author}\n\n`;  

      if (storyHistory.length > 0) {  
        context += "R√©sum√© des √©pisodes pr√©c√©dents :\n";  
        storyHistory.forEach((ep) => {  
          context += `√âpisode ${ep.episode} : ${ep.fullText.slice(0,300)}...\n`;  
        });  

        // üîπ Continuit√© stricte avec la derni√®re phrase
        const lastEp = storyHistory[storyHistory.length - 1].fullText.trim();  
        const sentences = lastEp.split(/(?<=[.!?])\s+/);  
        const lastSentence = sentences.pop()?.trim();  

        if (lastSentence) {  
          context += `\n‚ö†Ô∏è Le nouvel √©pisode doit commencer exactement par cette phrase : "${lastSentence}".\n\n`;  
        }  
      } else {  
        context += `R√©sum√© initial : ${summary}\n\n`;  
      }  

      if (consignes) {  
        context += `Consignes pour cet √©pisode : ${consignes}\n`;  
      }  

      if (minWords) context += `‚ö†Ô∏è Minimum ${minWords} mots.\n`;  

      context += `  
‚ö†Ô∏è Ne commence JAMAIS un √©pisode par "Le lendemain", "Deux mois plus tard", "De l‚Äôautre c√¥t√© de la ville" ou √©quivalent.  
‚ö†Ô∏è N‚Äôajoute pas de titre ni num√©ro d‚Äô√©pisode.  
‚ö†Ô∏è Dialogues sous forme de liste avec tiret en d√©but de ligne.  
‚ö†Ô∏è Style narratif fluide avec √©motions, dialogues, proverbes, po√®mes et r√©f√©rences bibliques.  
‚ö†Ô∏è L‚Äôhistoire doit progresser et ne pas r√©p√©ter les m√™mes √©v√©nements.  
`;  

      resultDiv.textContent = "‚è≥ Kouam√© AI r√©fl√©chit‚Ä¶";  

      const res = await fetch("/ask", {  
        method: "POST",  
        headers: { "Content-Type": "application/json" },  
        body: JSON.stringify({ data: "", question: context })  
      });  

      const reader = res.body.getReader();  
      const decoder = new TextDecoder();  
      let story = "";  
      while (true) {  
        const { done, value } = await reader.read();  
        if (done) break;  
        story += decoder.decode(value, { stream: true });  
        resultDiv.textContent = story;  
      }  

      // üé® Formatage
      story = formatStoryText(story);  

      // ‚úÖ V√©rification de la continuit√© au cas o√π l‚ÄôIA oublierait
      if (storyHistory.length > 0) {  
        const lastEp = storyHistory[storyHistory.length - 1].fullText.trim();  
        const sentences = lastEp.split(/(?<=[.!?])\s+/);  
        const lastSentence = sentences.pop()?.trim();  
        if (lastSentence && !story.startsWith(lastSentence)) {  
          story = `<span style="color:deepskyblue;font-weight:bold;">${lastSentence}</span> ` + story;  
        }  
      }  

      lastStory = story;  

      const fullContent = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${story}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;  
      resultDiv.innerHTML = fullContent;  

      storyHistory.push({   
        title,   
        episode: parseInt(episode, 10),   
        preview: story.slice(0,100)+"...",   
        content: fullContent,   
        fullText: story   
      });  

      renderHistory();  
      saveData();  
      document.getElementById("consignes").value = "";  
    }

    // ---------- Historique ----------
    function renderHistory() {
      historyDiv.innerHTML = "";
      storyHistory.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerText = `√âpisode ${item.episode} ‚Äì ${item.preview}`;
        div.onclick = () => {
          resultDiv.innerHTML = item.content;
        };
        historyDiv.appendChild(div);
      });
    }

    // ---------- Suivant ----------
    function nextEpisode() {
      const epInput = document.getElementById("episode");
      epInput.value = parseInt(epInput.value, 10) + 1;
    }

    // ---------- Sauvegarde ----------
    function saveData() {
      localStorage.setItem("kouameAIStories", JSON.stringify(storyHistory));
    }

    function loadData() {
      const data = localStorage.getItem("kouameAIStories");
      if (data) {
        storyHistory = JSON.parse(data);
        renderHistory();
      }
    }

    // ---------- Export PDF ----------
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      storyHistory.forEach(item => {
        doc.setFontSize(16);
        doc.text(item.title, 10, y);
        y += 10;
        doc.setFontSize(14);
        doc.text("√âpisode " + item.episode, 10, y);
        y += 10;
        doc.setFontSize(12);
        let splitText = doc.splitTextToSize(item.fullText.replace(/<[^>]+>/g, ''), 180);
        doc.text(splitText, 10, y);
        y += splitText.length * 7 + 10;
        if (y > 270) { doc.addPage(); y = 10; }
      });
      doc.save("histoire.pdf");
    }

    loadData();
  </script>
</body>
    </html>
