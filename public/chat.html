<!DOCTYPE html>  <html lang="fr">  
<head>  
  <meta charset="UTF-8"/>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>Kouam√© AI ‚Äì G√©n√©rateur d‚Äôhistoires</title>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  <style>  
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 20px; background: #121212; color: #fff; }  
    h1 { text-align: center; margin-bottom: 20px; }  
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }  
    input, textarea { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 16px; }  
    input { background: #1f1f1f; color: #fff; }  
    textarea { background: #1f1f1f; color: #fff; resize: vertical; }  
    #summary { height: 120px; }  
    #consignes { height: 150px; }  
    .btn-row { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }  
    button { background: #007bff; border: none; border-radius: 6px; color: white; padding: 12px 18px; font-size: 16px; cursor: pointer; }  
    button:hover { background: #0056b3; }  
    #minWords { width: 120px; background: #1f1f1f; color: #fff; }  
    #result { margin-top: 20px; padding: 20px; background: #1e1e1e; border-radius: 8px; line-height: 1.6; }  
    #result h2, #result h3 { color: #00bfff; }  
    #result strong { color: #ffcc00; }  
    #result em { color: #ffaaff; }  
    .signature { margin-top: 15px; font-size: 14px; color: #aaa; text-align: right; }  
    #history { margin-top: 30px; padding: 15px; background: #1a1a1a; border-radius: 8px; }  
    #history h2 { margin-top: 0; color: #ffcc00; }  
    #history ul { list-style: none; padding: 0; margin: 0; }  
    #history li { padding: 8px; margin: 5px 0; background: #2a2a2a; border-radius: 5px; cursor: pointer; }  
    #history li:hover { background: #444; }  
    #exportBtn { margin-top: 15px; background: #28a745; }  
    #exportBtn:hover { background: #1e7e34; }  
    .btn-modify { background: #ffc107; color: #000; }  
    .btn-modify:hover { background: #e0a800; }  /* üé® Styles personnalis√©s */  
.dialogue { color: #1e90ff; }       /* Bleu pour dialogues */  
.proverbe { color: #ff4444; }       /* Rouge pour proverbes */  
.poeme { color: #ff69b4; font-style: italic; } /* Rose pour po√®mes */  
.bible { color: #ffcc00; font-weight: bold; } /* Jaune gras pour Bible */

  </style>  
</head>  
<body>  
  <h1>üìñ G√©n√©rateur d‚Äôhistoires ‚Äì Kouam√© AI</h1>    <!-- Ligne titre / √©pisode / auteur -->    <div class="form-row">  
    <input id="title" type="text" placeholder="Titre de l‚Äôhistoire">  
    <input id="episode" type="number" placeholder="√âpisode">  
    <input id="author" type="text" placeholder="Auteur">  
  </div>    <!-- R√©sum√© initial -->  <label for="summary">R√©sum√© de base (pr√©sentation des personnages et contexte) :</label>

  <textarea id="summary" placeholder="D√©crivez vos personnages, univers et contexte de d√©part..."></textarea>    <!-- Zone de consignes -->  <label for="consignes">Consignes / Modifications :</label>

  <textarea id="consignes" placeholder="Laissez vide pour que l‚ÄôIA continue seule, ou √©crivez vos consignes ici..."></textarea>    <!-- Ligne boutons -->    <div class="btn-row">  
    <button onclick="generateStory()">Ai Kouam√© g√©n√©r√©</button>  
    <input id="minWords" type="number" placeholder="N (mots min)">  
    <button onclick="nextEpisode()">√âpisode suivant</button>  
    <button onclick="editEpisode()" class="btn-modify">‚úèÔ∏è Modifier √©pisode</button>  
    <button onclick="styleStory()">S</button>  
    <button onclick="resetStory()" style="background:#dc3545;">üîÑ R√©initialiser</button>  
  </div>    <!-- R√©sultat -->    <div id="result"></div>    <!-- Historique -->    <div id="history">  
    <h2>üìö Historique des √©pisodes</h2>  
    <ul id="historyList"></ul>  
    <button id="exportBtn" onclick="exportPDF()">üì• Exporter en PDF</button>  
  </div>    <script>  
    const resultDiv = document.getElementById("result");  
    const historyList = document.getElementById("historyList");  
    let lastStory = "";   
    let storyHistory = [];   
  
    // üé® Fonction de formatage  
    function formatStoryText(text) {  
      let formatted = text  
        // Dialogues commen√ßant par -  
        .replace(/(^|\n)-\s*([^.\n!?]+[.\n!?]*)/g, (m, p1, p2) => `${p1}<span class="dialogue">- ${p2.trim()}</span>`)  
        // Proverbes entre guillemets ¬´ ‚Ä¶ ¬ª  
        .replace(/¬´([^¬ª]+)¬ª/g, '<span class="proverbe">¬´$1¬ª</span>')  
        // Po√®mes entre [poeme]...[/poeme]  
        .replace(/ÓÄÅpoemeÓÄÅ([\s\S]*?)ÓÄÅ\/poemeÓÄÅ/g, '<span class="poeme">$1</span>')  
        // Bible entre [bible]...[/bible]  
        .replace(/ÓÄÅbibleÓÄÅ([\s\S]*?)ÓÄÅ\/bibleÓÄÅ/g, '<span class="bible">$1</span>')  
        // Ajout de retours √† la ligne  
        .replace(/([.!?])\s*/g, "$1<br><br>");  
  
      return formatted.trim();  
    }  
  
    // ---------- Sauvegarde ----------  
    function saveData() {  
      const data = {  
        title: document.getElementById("title").value,  
        episode: document.getElementById("episode").value,  
        author: document.getElementById("author").value,  
        summary: document.getElementById("summary").value,  
        history: storyHistory,  
        result: resultDiv.innerHTML  
      };  
      localStorage.setItem("storyData", JSON.stringify(data));  
    }  
  
    function loadData() {  
      const saved = localStorage.getItem("storyData");  
      if (!saved) return;  
      const data = JSON.parse(saved);  
      document.getElementById("title").value = data.title || "";  
      document.getElementById("episode").value = data.episode || "";  
      document.getElementById("author").value = data.author || "";  
      document.getElementById("summary").value = data.summary || "";  
      storyHistory = data.history || [];  
      resultDiv.innerHTML = data.result || "";  
      renderHistory();  
    }  
  
    window.onload = loadData;  
    window.onbeforeunload = saveData;  
  
    // ---------- Historique ----------  
    function renderHistory() {  
      historyList.innerHTML = "";  
      storyHistory.forEach((ep) => {  
        const li = document.createElement("li");  
        li.textContent = ep.title + " ‚Äì √âpisode " + ep.episode;  
        li.onclick = () => { resultDiv.innerHTML = ep.content; lastStory = ep.fullText; };  
        historyList.appendChild(li);  
      });  
    }  
  
    // ---------- G√©n√©ration ----------  
    async function generateStory() {  
      const title = document.getElementById("title").value.trim();  
      const episode = document.getElementById("episode").value.trim();  
      const author = document.getElementById("author").value.trim();  
      const summary = document.getElementById("summary").value.trim();  
      const consignes = document.getElementById("consignes").value.trim();  
      const minWords = document.getElementById("minWords").value.trim();  
  
      if (!title || !episode || !author) { alert("Veuillez remplir Titre, √âpisode et Auteur !"); return; }  
  
      let context = `Titre : ${title}\n√âpisode ${episode}\nAuteur : ${author}\n\nR√©sum√© initial : ${summary}\n\n`;  
  
      // Continuit√© avec derni√®re phrase  
      if (storyHistory.length > 0) {  
        const lastEp = storyHistory[storyHistory.length - 1].fullText.trim();  
        const lastSentence = lastEp.split(/(?<=[.!?])\s+/).pop();  
        context += `‚ö†Ô∏è Le nouvel √©pisode doit commencer par cette phrase : "${lastSentence}".\n\n`;  
      }  
  
      if (consignes) {  
        context += `Consignes pour cet √©pisode : ${consignes}\n`;  
      } else {  
        context += "‚ö†Ô∏è Continue naturellement l‚Äôhistoire avec coh√©rence et √©volution des √©v√©nements.\n";  
      }  
  
      if (minWords) context += `‚ö†Ô∏è Minimum ${minWords} mots.\n`;  
  
      context += `  
‚ö†Ô∏è Ne commence JAMAIS un √©pisode par "Le lendemain", "Deux mois plus tard", "De l‚Äôautre c√¥t√© de la ville" ou √©quivalent.  
‚ö†Ô∏è N‚Äôajoute pas de titre ni num√©ro d‚Äô√©pisode.  
‚ö†Ô∏è Dialogues sous forme de liste avec tiret en d√©but de ligne.  
‚ö†Ô∏è Style narratif fluide avec √©motions, dialogues, proverbes, po√®mes et r√©f√©rences bibliques.  
`;  
  
      resultDiv.textContent = "‚è≥ Kouam√© AI r√©fl√©chit‚Ä¶";  
  
      const res = await fetch("/ask", {  
        method: "POST",  
        headers: { "Content-Type": "application/json" },  
        body: JSON.stringify({ data: "", question: context })  
      });  
  
      const reader = res.body.getReader();  
      const decoder = new TextDecoder();  
      let story = "";  
      while (true) {  
        const { done, value } = await reader.read();  
        if (done) break;  
        story += decoder.decode(value, { stream: true });  
        resultDiv.textContent = story;  
      }  
  
      // üé® Formatage  
      story = formatStoryText(story);  
      lastStory = story;  
  
      const fullContent = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${story}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;  
      resultDiv.innerHTML = fullContent;  
  
      storyHistory.push({   
        title,   
        episode: parseInt(episode, 10),   
        preview: story.slice(0,100)+"...",   
        content: fullContent,   
        fullText: story   
      });  
  
      renderHistory(); saveData();  
      document.getElementById("consignes").value = "";  
    }  
  
    // ---------- Modifier √©pisode ----------  
    async function editEpisode() {  
      if (!lastStory) { alert("Aucun √©pisode √† modifier !"); return; }  
      const consignes = document.getElementById("consignes").value.trim();  
      if (!consignes) { alert("√âcrivez vos consignes de modification !"); return; }  
      const title = document.getElementById("title").value.trim();  
      const episode = document.getElementById("episode").value.trim();  
      const author = document.getElementById("author").value.trim();  
  
      const editPrompt = `  
Voici le texte original de l‚Äô√©pisode ${episode} de l‚Äôhistoire "${title}" :  
  
${lastStory}  
  
Consignes de modification : "${consignes}".  
  
‚ö†Ô∏è Applique uniquement ces changements.  
‚ö†Ô∏è Ne modifie rien d‚Äôautre.  
‚ö†Ô∏è Ne rajoute pas de titre ni num√©ro d‚Äô√©pisode.  
`;  
  
      resultDiv.textContent = "‚úèÔ∏è Application des modifications‚Ä¶";  
  
      const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:editPrompt }) });  
      const reader = res.body.getReader(); const decoder = new TextDecoder(); let modified = "";  
      while (true) { const {done, value} = await reader.read(); if (done) break; modified += decoder.decode(value,{stream:true}); resultDiv.textContent = modified; }  
  
      modified = formatStoryText(modified);  
      lastStory = modified;  
  
      const existing = storyHistory.find(ep => ep.episode === parseInt(episode, 10));  
      if (existing) {  
        existing.fullText = modified;  
        existing.preview = modified.slice(0,100)+"...";  
        existing.content = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${modified}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;  
        resultDiv.innerHTML = existing.content;  
      }  
      renderHistory(); saveData();  
      document.getElementById("consignes").value = "";  
    }  
  
    async function nextEpisode() {   
      const epInput = document.getElementById("episode");   
      epInput.value = parseInt(epInput.value||"0")+1;   
      await generateStory();   
    }  
  
    async function styleStory() {  
      if (!lastStory) { alert("G√©n√©rez d‚Äôabord une histoire !"); return; }  
      const stylePrompt = `R√©√©cris ce texte avec style (gras, italique, emojis), sans changer le sens ni rajouter titre ou num√©ro :\n${lastStory}`;  
      resultDiv.textContent = "‚ú® Application du style‚Ä¶";  
      const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:stylePrompt }) });  
      const reader = res.body.getReader(); const decoder = new TextDecoder(); let styled = "";  
      while (true) { const {done, value} = await reader.read(); if (done) break; styled += decoder.decode(value,{stream:true}); resultDiv.textContent = styled; }  
      styled = formatStoryText(styled);  
      lastStory = styled;  
      const episode = document.getElementById("episode").value.trim(); const title = document.getElementById("title").value.trim(); const author = document.getElementById("author").value.trim();  
      const existing = storyHistory.find(ep => ep.episode === parseInt(episode, 10));  
      if (existing) {   
        existing.fullText = styled;   
        existing.preview = styled.slice(0,100)+"...";   
        existing.content = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${styled}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;   
        resultDiv.innerHTML = existing.content;   
      }  
      renderHistory(); saveData();  
    }  
  
    // ---------- R√©initialiser ----------  
    function resetStory() {  
      if (!confirm("Voulez-vous vraiment r√©initialiser l‚Äôhistoire ?")) return;  
      localStorage.removeItem("storyData");  
      document.getElementById("title").value=""; document.getElementById("episode").value=""; document.getElementById("author").value=""; document.getElementById("summary").value=""; document.getElementById("consignes").value="";  
      resultDiv.innerHTML=""; historyList.innerHTML=""; storyHistory=[]; lastStory="";  
    }  
  
    // ---------- Export PDF ----------  
    async function exportPDF() {  
      if (storyHistory.length===0) { alert("Aucune histoire √† exporter !"); return; }  
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=30;  
      const title=document.getElementById("title").value||"Mon Histoire"; const author=document.getElementById("author").value||"Inconnu"; const summary=document.getElementById("summary").value||"Pas de r√©sum√©";  
      doc.setFontSize(24); doc.setTextColor(30,144,255); doc.text(title,105,y,{align:"center"}); y+=20;  
      doc.setFontSize(16); doc.setTextColor(0,0,0); doc.text("Auteur : "+author,105,y,{align:"center"}); y+=20;  
      doc.setFontSize(14); doc.setTextColor(80,80,80); const summaryLines=doc.splitTextToSize("R√©sum√© : "+summary,170); doc.text(summaryLines,20,y); doc.addPage();  
      y=20;  
      storyHistory.forEach((ep)=>{   
        doc.setFontSize(16); doc.setTextColor(255,69,0);   
        doc.text(`√âpisode ${ep.episode}`,20,y); y+=10;   
        doc.setFontSize(12); doc.setTextColor(0,0,0);   
        const lines=doc.splitTextToSize(ep.fullText.replace(/<[^>]+>/g,""),170);   
        lines.forEach(line=>{   
          if(y>270){doc.addPage(); y=20;}   
          doc.text(line,20,y,{align:"justify"});   
          y+=7;   
        });   
        y+=10;   
      });  
      doc.setFontSize(10); doc.setTextColor(100,100,100); doc.text("D√©veloppeur : Sossou Kouam√©",105,290,{align:"center"});  
      doc.save(`${title}.pdf`);  
    }  
  </script>  </body>  
  </html>
