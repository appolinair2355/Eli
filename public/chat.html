<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kouam√© AI ‚Äì G√©n√©rateur d‚Äôhistoires</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 20px; background: #121212; color: #fff; }
    h1 { text-align: center; margin-bottom: 20px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
    input, textarea { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 16px; }
    input { background: #1f1f1f; color: #fff; }
    textarea { background: #1f1f1f; color: #fff; resize: vertical; }
    #summary { height: 120px; }
    #consignes { height: 150px; }
    .btn-row { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { background: #007bff; border: none; border-radius: 6px; color: white; padding: 12px 18px; font-size: 16px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #minWords, #numEpisodes { width: 140px; background: #1f1f1f; color: #fff; }
    #result { margin-top: 20px; padding: 20px; background: #1e1e1e; border-radius: 8px; line-height: 1.6; min-height: 100px; }
    #result h2, #result h3 { color: #00bfff; }
    #result strong { color: #ffcc00; }
    #result em { color: #ffaaff; }
    .signature { margin-top: 15px; font-size: 14px; color: #aaa; text-align: right; }
    #history { margin-top: 30px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
    #history h2 { margin-top: 0; color: #ffcc00; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 8px; margin: 5px 0; background: #2a2a2a; border-radius: 5px; cursor: pointer; }
    #history li:hover { background: #444; }
    #exportBtn { margin-top: 15px; background: #28a745; }
    #exportBtn:hover { background: #1e7e34; }
    .btn-modify { background: #ffc107; color: #000; }
    .btn-modify:hover { background: #e0a800; }
    .btn-full { background: #6f42c1; }
    .btn-full:hover { background: #563d7c; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>üìñ G√©n√©rateur d‚Äôhistoires ‚Äì Kouam√© AI</h1>

  <!-- Ligne titre / √©pisode / auteur -->
  <div class="form-row">
    <input id="title" type="text" placeholder="Titre de l‚Äôhistoire">
    <input id="episode" type="number" placeholder="√âpisode">
    <input id="author" type="text" placeholder="Auteur">
  </div>

  <!-- R√©sum√© initial -->
  <label for="summary">R√©sum√© de base (pr√©sentation des personnages et contexte) :</label>
  <textarea id="summary" placeholder="D√©crivez vos personnages, univers et contexte de d√©part..."></textarea>

  <!-- Zone de consignes -->
  <label for="consignes">Consignes / Modifications :</label>
  <textarea id="consignes" placeholder="Laissez vide pour que l‚ÄôIA continue seule, ou √©crivez vos consignes ici..."></textarea>

  <!-- Ligne boutons -->
  <div class="btn-row">
    <button onclick="generateStory()">Ai Kouam√© g√©n√©r√©</button>
    <input id="minWords" type="number" placeholder="Mots/√©pisode">
    <input id="numEpisodes" type="number" placeholder="Nb √©pisodes (15-20)">
    <button onclick="nextEpisode()">√âpisode suivant</button>
    <button onclick="editEpisode()" class="btn-modify">‚úèÔ∏è Modifier √©pisode</button>
    <button onclick="styleStory()">S</button>
    <button onclick="generateFullStory()" class="btn-full">üìñ Histoire compl√®te</button>
    <button onclick="resetStory()" style="background:#dc3545;">üîÑ R√©initialiser</button>
  </div>

  <!-- R√©sultat -->
  <div id="result"></div>

  <!-- Historique -->
  <div id="history">
    <h2>üìö Historique des √©pisodes</h2>
    <ul id="historyList"></ul>
    <button id="exportBtn" onclick="exportPDF()">üì• Exporter en PDF</button>
  </div>

  <script>
    const resultDiv = document.getElementById("result");
    const historyList = document.getElementById("historyList");
    let lastStory = ""; 
    let storyHistory = []; 

    // ---------- Sauvegarde ----------
    function saveData() {
      const data = {
        title: document.getElementById("title").value,
        episode: document.getElementById("episode").value,
        author: document.getElementById("author").value,
        summary: document.getElementById("summary").value,
        history: storyHistory,
        result: resultDiv.innerHTML
      };
      localStorage.setItem("storyData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("storyData");
      if (!saved) return;
      const data = JSON.parse(saved);
      document.getElementById("title").value = data.title || "";
      document.getElementById("episode").value = data.episode || "";
      document.getElementById("author").value = data.author || "";
      document.getElementById("summary").value = data.summary || "";
      storyHistory = data.history || [];
      resultDiv.innerHTML = data.result || "";
      renderHistory();
    }

    window.onload = loadData;
    window.onbeforeunload = saveData;

    // ---------- Historique ----------
    function renderHistory() {
      historyList.innerHTML = "";
      storyHistory.forEach((ep) => {
        const li = document.createElement("li");
        li.textContent = ep.title + " ‚Äì √âpisode " + ep.episode;
        li.onclick = () => { resultDiv.innerHTML = ep.content; lastStory = ep.fullText; };
        historyList.appendChild(li);
      });
    }

    // ---------- Utilitaire lecture flux ----------
    async function readStream(res, onChunk) {
      if (!res.ok) throw new Error("Erreur serveur : " + res.status);
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let text = "";
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        text += decoder.decode(value, { stream: true });
        if (onChunk) onChunk(text);
      }
      return text;
    }

    // ---------- G√©n√©ration √©pisode ----------
    async function generateStory() {
      try {
        const title = document.getElementById("title").value.trim();
        const episode = document.getElementById("episode").value.trim();
        const author = document.getElementById("author").value.trim();
        const summary = document.getElementById("summary").value.trim();
        const consignes = document.getElementById("consignes").value.trim();
        const minWords = document.getElementById("minWords").value.trim();

        if (!title || !episode || !author) { alert("Veuillez remplir Titre, √âpisode et Auteur !"); return; }

        let context = `Titre : ${title}\n√âpisode ${episode}\nAuteur : ${author}\n\nR√©sum√© initial : ${summary}\n\n`;
        if (storyHistory.length > 0) {
          context += `Texte des √©pisodes pr√©c√©dents :\n`;
          storyHistory.forEach(e => context += `--- √âpisode ${e.episode} ---\n${e.fullText}\n\n`);
        }
        if (consignes) context += `Consignes : ${consignes}\n`;
        else context += "‚ö†Ô∏è Continue naturellement l‚Äôhistoire avec coh√©rence.\n";
        if (minWords) context += `‚ö†Ô∏è Minimum ${minWords} mots.\n`;

        context += `‚ö†Ô∏è Style narratif fluide avec dialogues, emojis, gras et italique.\n`;

        resultDiv.textContent = "‚è≥ Kouam√© AI r√©fl√©chit‚Ä¶";

        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: "", question: context })
        });

        const story = await readStream(res, text => resultDiv.textContent = text);
        lastStory = story;

        const fullContent = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${story}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;
        resultDiv.innerHTML = fullContent;
        storyHistory.push({ title, episode, preview: story.slice(0,100)+"...", content: fullContent, fullText: story });

        renderHistory(); saveData();
        document.getElementById("consignes").value = "";
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">‚ùå Erreur g√©n√©ration √©pisode : ${err.message}</p>`;
      }
    }

    // ---------- Modifier √©pisode ----------
    async function editEpisode() {
      try {
        if (!lastStory) { alert("Aucun √©pisode √† modifier !"); return; }
        const consignes = document.getElementById("consignes").value.trim();
        if (!consignes) { alert("√âcrivez vos consignes !"); return; }
        const title = document.getElementById("title").value.trim();
        const episode = document.getElementById("episode").value.trim();
        const author = document.getElementById("author").value.trim();

        const editPrompt = `Texte original √©pisode ${episode} de "${title}" :\n${lastStory}\n\nConsignes : ${consignes}\n‚ö†Ô∏è Applique uniquement ces changements.\n`;

        resultDiv.textContent = "‚úèÔ∏è Application des modifications‚Ä¶";

        const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:editPrompt }) });
        const modified = await readStream(res, text => resultDiv.textContent = text);
        lastStory = modified;

        const existing = storyHistory.find(ep => ep.episode === episode);
        if (existing) {
          existing.fullText = modified;
          existing.preview = modified.slice(0,100)+"...";
          existing.content = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${modified}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;
          resultDiv.innerHTML = existing.content;
        }
        renderHistory(); saveData();
        document.getElementById("consignes").value = "";
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">‚ùå Erreur modification : ${err.message}</p>`;
      }
    }

    async function nextEpisode() { 
      const epInput = document.getElementById("episode"); 
      epInput.value = parseInt(epInput.value||"0")+1; 
      await generateStory(); 
    }

    async function styleStory() {
      try {
        if (!lastStory) { alert("G√©n√©rez d‚Äôabord une histoire !"); return; }
        const stylePrompt = `R√©√©cris ce texte avec style (gras, italique, emojis), sans changer le sens :\n${lastStory}`;
        resultDiv.textContent = "‚ú® Application du style‚Ä¶";
        const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:stylePrompt }) });
        const styled = await readStream(res, text => resultDiv.textContent = text);
        lastStory = styled;

        const episode = document.getElementById("episode").value.trim(); 
        const title = document.getElementById("title").value.trim(); 
        const author = document.getElementById("author").value.trim();
        const existing = storyHistory.find(ep => ep.episode === episode);
        if (existing) {
          existing.fullText = styled;
          existing.preview = styled.slice(0,100)+"...";
          existing.content = `<h2>${title}</h2><h3>√âpisode ${episode}</h3><div>${styled}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;
          resultDiv.innerHTML = existing.content;
        }
        renderHistory(); saveData();
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">‚ùå Erreur style : ${err.message}</p>`;
      }
    }

    // ---------- Histoire compl√®te ----------
    async function generateFullStory() {
      try {
        const title = document.getElementById("title").value.trim();
        const author = document.getElementById("author").value.trim();
        const summary = document.getElementById("summary").value.trim();
        const consignes = document.getElementById("consignes").value.trim();
        const minWords = document.getElementById("minWords").value.trim();
        let numEpisodes = parseInt(document.getElementById("numEpisodes").value.trim());

        if (!title || !author) { alert("Veuillez remplir Titre et Auteur !"); return; }
        if (isNaN(numEpisodes) || numEpisodes < 15) numEpisodes = 15;
        if (numEpisodes > 20) numEpisodes = 20;

        let context = `Titre : ${title}\nAuteur : ${author}\nR√©sum√© initial : ${summary}\n\n`;
        if (consignes) context += `Consignes : ${consignes}\n`;

        context += `‚ö†Ô∏è Raconte l‚Äôhistoire compl√®te en ${numEpisodes} √©pisodes.
‚ö†Ô∏è Chaque √©pisode doit avoir au moins ${minWords || 200} mots.
‚ö†Ô∏è S√©pare clairement chaque √©pisode par "√âpisode X".
‚ö†Ô∏è Fais √©voluer les personnages et termine avec une conclusion et une morale.
‚ö†Ô∏è Style riche avec dialogues, descriptions, emojis, gras et italique.\n`;

        resultDiv.textContent = "‚è≥ Kouam√© AI √©crit toute l‚Äôhistoire‚Ä¶";

        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: "", question: context })
        });

        const fullStory = await readStream(res, text => resultDiv.textContent = text);
        lastStory = fullStory;

        const fullContent = `<h2>${title}</h2><h3>Histoire compl√®te (${numEpisodes} √©pisodes)</h3><div>${fullStory}</div><div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;
        resultDiv.innerHTML = fullContent;

        storyHistory.push({ title, episode: "Complet", preview: fullStory.slice(0,100)+"...", content: fullContent, fullText: fullStory });

        renderHistory(); saveData();
        document.getElementById("consignes").value = "";
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="error">‚ùå Erreur histoire compl√®te : ${err.message}</p>`;
      }
    }

    // ---------- R√©initialiser ----------
    function resetStory() {
      if (!confirm("Voulez-vous vraiment r√©initialiser l‚Äôhistoire ?")) return;
      localStorage.removeItem("storyData");
      document.getElementById("title").value=""; document.getElementById("episode").value=""; document.getElementById("author").value=""; document.getElementById("summary").value=""; document.getElementById("consignes").value="";
      resultDiv.innerHTML=""; historyList.innerHTML=""; storyHistory=[]; lastStory="";
    }

    // ---------- Export PDF ----------
    async function exportPDF() {
      if (storyHistory.length===0) { alert("Aucune histoire √† exporter !"); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=30;
      const title=document.getElementById("title").value||"Mon Histoire"; 
      const author=document.getElementById("author").value||"Inconnu"; 
      const summary=document.getElementById("summary").value||"Pas de r√©sum√©";
      doc.setFontSize(24); doc.setTextColor(30,144,255); doc.text(title,105,y,{align:"center"}); y+=20;
      doc.setFontSize(16); doc.setTextColor(0,0,0); doc.text("Auteur : "+author,105,y,{align:"center"}); y+=20;
      doc.setFontSize(14); doc.setTextColor(80,80,80); const summaryLines=doc.splitTextToSize("R√©sum√© : "+summary,170); doc.text(summaryLines,20,y); doc.addPage();
      y=20;
      storyHistory.forEach((ep)=>{ 
        doc.setFontSize(16); doc.setTextColor(255,69,0); 
        doc.text(`√âpisode ${ep.episode}`,
