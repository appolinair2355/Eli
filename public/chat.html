<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KouamÃ© AI â€“ GÃ©nÃ©rateur dâ€™histoires</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 20px; background: #121212; color: #fff; }
    h1 { text-align: center; margin-bottom: 20px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
    input, textarea { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 16px; }
    input { background: #1f1f1f; color: #fff; }
    textarea { background: #1f1f1f; color: #fff; resize: vertical; }
    #summary { height: 120px; }
    #consignes { height: 150px; }
    .btn-row { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { background: #007bff; border: none; border-radius: 6px; color: white; padding: 12px 18px; font-size: 16px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #minWords { width: 120px; background: #1f1f1f; color: #fff; }
    #result { margin-top: 20px; padding: 20px; background: #1e1e1e; border-radius: 8px; line-height: 1.6; }
    #result h2, #result h3 { color: #00bfff; }
    #result strong { color: #ffcc00; }
    #result em { color: #ffaaff; }
    .signature { margin-top: 15px; font-size: 14px; color: #aaa; text-align: right; }
    #history { margin-top: 30px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
    #history h2 { margin-top: 0; color: #ffcc00; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 8px; margin: 5px 0; background: #2a2a2a; border-radius: 5px; cursor: pointer; }
    #history li:hover { background: #444; }
    #exportBtn { margin-top: 15px; background: #28a745; }
    #exportBtn:hover { background: #1e7e34; }
    .btn-modify { background: #ffc107; color: #000; }
    .btn-modify:hover { background: #e0a800; }

    /* ğŸ¨ Styles personnalisÃ©s */
    .dialogue { color: #1e90ff; }
    .proverbe { color: #ff4444; }
    .poeme { color: #ff69b4; font-style: italic; }
    .bible { color: #ffcc00; font-weight: bold; }
    .highlight { color: #00bfff; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ“– GÃ©nÃ©rateur dâ€™histoires â€“ KouamÃ© AI</h1>

  <!-- Ligne titre / Ã©pisode / auteur -->
  <div class="form-row">
    <input id="title" type="text" placeholder="Titre de lâ€™histoire">
    <input id="episode" type="number" placeholder="Ã‰pisode">
    <input id="author" type="text" placeholder="Auteur">
  </div>

  <!-- RÃ©sumÃ© initial -->
  <label for="summary">RÃ©sumÃ© de base (prÃ©sentation des personnages et contexte) :</label>
  <textarea id="summary" placeholder="DÃ©crivez vos personnages, univers et contexte de dÃ©part..."></textarea>

  <!-- Zone de consignes -->
  <label for="consignes">Consignes / Modifications :</label>
  <textarea id="consignes" placeholder="Laissez vide pour que lâ€™IA continue seule, ou Ã©crivez vos consignes ici..."></textarea>

  <!-- Ligne boutons -->
  <div class="btn-row">
    <button onclick="generateStory()">Ai KouamÃ© gÃ©nÃ©rÃ©</button>
    <input id="minWords" type="number" placeholder="N (mots min)">
    <button onclick="nextEpisode()">Ã‰pisode suivant</button>
    <button onclick="editEpisode()" class="btn-modify">âœï¸ Modifier Ã©pisode</button>
    <button onclick="styleStory()">S</button>
    <button onclick="resetStory()" style="background:#dc3545;">ğŸ”„ RÃ©initialiser</button>
    <button onclick="copyEpisode()" style="background:#17a2b8;">ğŸ“‹ Copier</button>
    <button onclick="deleteEpisode()" style="background:#ff4444;">ğŸ—‘ Supprimer Ã©pisode</button>
    <button onclick="exportCurrentPDF()" style="background:#6f42c1;">ğŸ“„ Exporter Ã©pisode</button>
    <input id="searchHistory" type="text" placeholder="ğŸ” Rechercher..." oninput="filterHistory()" style="max-width:200px;">
  </div>

  <!-- RÃ©sultat -->
  <div id="result"></div>

  <!-- Historique -->
  <div id="history">
    <h2>ğŸ“š Historique des Ã©pisodes</h2>
    <ul id="historyList"></ul>
    <button id="exportBtn" onclick="exportPDF()">ğŸ“¥ Exporter en PDF</button>
  </div>

  <script>
    const resultDiv = document.getElementById("result");
    const historyList = document.getElementById("historyList");
    let lastStory = "";
    let storyHistory = [];

    // ğŸ¨ Fonction de formatage
    function formatStoryText(text) {
      let formatted = text
        .replace(/(^|\n)-\s*([^.\n!?]+[.\n!?]*)/g, (m, p1, p2) => `${p1}<span class="dialogue">- ${p2.trim()}</span>`)
        .replace(/Â«([^Â»]+)Â»/g, '<span class="proverbe">Â«$1Â»</span>')
        .replace(/î€poemeî€([\s\S]*?)î€\/poemeî€/g, '<span class="poeme">$1</span>')
        .replace(/î€bibleî€([\s\S]*?)î€\/bibleî€/g, '<span class="bible">$1</span>')
        .replace(/([.!?])\s*/g, "$1<br><br>");
      return formatted.trim();
    }

    // ---------- Sauvegarde ----------
    function saveData() {
      const data = {
        title: document.getElementById("title").value,
        episode: document.getElementById("episode").value,
        author: document.getElementById("author").value,
        summary: document.getElementById("summary").value,
        history: storyHistory,
        result: resultDiv.innerHTML
      };
      localStorage.setItem("storyData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("storyData");
      if (!saved) return;
      const data = JSON.parse(saved);
      document.getElementById("title").value = data.title || "";
      document.getElementById("episode").value = data.episode || "";
      document.getElementById("author").value = data.author || "";
      document.getElementById("summary").value = data.summary || "";
      storyHistory = data.history || [];
      resultDiv.innerHTML = data.result || "";
      renderHistory();
    }

    window.onload = loadData;
    window.onbeforeunload = saveData;

    // ---------- Historique ----------
    function renderHistory() {
      historyList.innerHTML = "";
      storyHistory.forEach((ep) => {
        const li = document.createElement("li");
        li.textContent = ep.title + " â€“ Ã‰pisode " + ep.episode;
        li.onclick = () => { resultDiv.innerHTML = ep.content; lastStory = ep.fullText; };
        historyList.appendChild(li);
      });
    }

    // ---------- GÃ©nÃ©ration ----------
    async function generateStory() {
      const title = document.getElementById("title").value.trim();
      const episode = document.getElementById("episode").value.trim();
      const author = document.getElementById("author").value.trim();
      const summary = document.getElementById("summary").value.trim();
      const consignes = document.getElementById("consignes").value.trim();
      const minWords = document.getElementById("minWords").value.trim();

      if (!title || !episode || !author) { alert("Veuillez remplir Titre, Ã‰pisode et Auteur !"); return; }

      let context = `Titre : ${title}\nÃ‰pisode ${episode}\nAuteur : ${author}\n\nRÃ©sumÃ© initial : ${summary}\n\n`;

      // ContinuitÃ© avec derniÃ¨re phrase
      if (storyHistory.length > 0) {
        const lastEp = storyHistory[storyHistory.length - 1].fullText.replace(/<[^>]+>/g,"").trim();
        const lastSentence = lastEp.split(/(?<=[.!?])\s+/).pop();
        context += `âš ï¸ Le nouvel Ã©pisode doit commencer par cette phrase : "${lastSentence}".\n\n`;
      }

      if (consignes) {
        context += `Consignes pour cet Ã©pisode : ${consignes}\n`;
      } else {
        context += "âš ï¸ Continue naturellement lâ€™histoire avec cohÃ©rence et Ã©volution des Ã©vÃ©nements.\n";
      }

      if (minWords) context += `âš ï¸ Minimum ${minWords} mots.\n`;

      context += `
âš ï¸ Ne commence JAMAIS un Ã©pisode par "Le lendemain", "Deux mois plus tard", "De lâ€™autre cÃ´tÃ© de la ville" ou Ã©quivalent.
âš ï¸ Nâ€™ajoute pas de titre ni numÃ©ro dâ€™Ã©pisode.
âš ï¸ Dialogues sous forme de liste avec tiret en dÃ©but de ligne.
âš ï¸ Style narratif fluide avec Ã©motions, dialogues, proverbes, poÃ¨mes et rÃ©fÃ©rences bibliques.
`;

      resultDiv.textContent = "â³ KouamÃ© AI rÃ©flÃ©chitâ€¦";

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: "", question: context })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let story = "";
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        story += decoder.decode(value, { stream: true });
        resultDiv.textContent = story;
      }

      // VÃ©rification stricte de continuitÃ©
      if (storyHistory.length > 0) {
        const lastEp = storyHistory[storyHistory.length - 1].fullText.replace(/<[^>]+>/g,"").trim();
        const sentences = lastEp.split(/(?<=[.!?])\s+/);
        const lastSentence = sentences.pop()?.trim();
        if (lastSentence && !story.startsWith(lastSentence)) {
          story = lastSentence + " " + story;
        }
        // Mise en Ã©vidence visuelle
        story = story.replace(lastSentence, `<span class="highlight">${lastSentence}</span>`);
      }

      // ğŸ¨ Formatage
      story = formatStoryText(story);
      lastStory = story;

      const fullContent = `<h2>${title}</h2><h3>Ã‰pisode ${episode}</h3><div>${story}</div><div class="signature">Auteur : ${author}<br>DÃ©veloppeur : Sossou KouamÃ©</div>`;
      resultDiv.innerHTML = fullContent;

      storyHistory.push({
        title,
        episode: parseInt(episode, 10),
        preview: story.slice(0,100)+"...",
        content: fullContent,
        fullText: story
      });

      renderHistory(); saveData();
      document.getElementById("consignes").value = "";
    }

    // ---------- Modifier Ã©pisode ----------
    async function editEpisode() {
      if (!lastStory) { alert("Aucun Ã©pisode Ã  modifier !"); return; }
      const consignes = document.getElementById("consignes").value.trim();
      if (!consignes) { alert("Ã‰crivez vos consignes de modification !"); return; }
      const title = document.getElementById("title").value.trim();
      const episode = document.getElementById("episode").value.trim();
      const author = document.getElementById("author").value.trim();

      const editPrompt = `
Voici le texte original de lâ€™Ã©pisode ${episode} de lâ€™histoire "${title}" :

${lastStory}

Consignes de modification : "${consignes}".

âš ï¸ Applique uniquement ces changements.
âš ï¸ Ne modifie rien dâ€™autre.
âš ï¸ Ne rajoute pas de titre ni numÃ©ro dâ€™Ã©pisode.
`;

      resultDiv.textContent = "âœï¸ Application des modificationsâ€¦";

      const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:editPrompt }) });
      const reader = res.body.getReader(); const decoder = new TextDecoder(); let modified = "";
      while (true) { const {done, value} = await reader.read(); if (done) break; modified += decoder.decode(value,{stream:true}); resultDiv.textContent = modified; }

      modified = formatStoryText(modified);
      lastStory = modified;

      const existing = storyHistory.find(ep => ep.episode === parseInt(episode, 10));
      if (existing) {
        existing.fullText = modified;
        existing.preview = modified.slice(0,100)+"...";
        existing.content = `<h2>${title}</h2><h3>Ã‰pisode ${episode}</h3><div>${modified}</div><div class="signature">Auteur : ${author}<br>DÃ©veloppeur : Sossou KouamÃ©</div>`;
        resultDiv.innerHTML = existing.content;
      }
      renderHistory(); saveData();
      document.getElementById("consignes").value = "";
    }

    async function nextEpisode() {
      const epInput = document.getElementById("episode");
      epInput.value = parseInt(epInput.value||"0")+1;
      await generateStory();
    }

    async function styleStory() {
      if (!lastStory) { alert("GÃ©nÃ©rez dâ€™abord une histoire !"); return; }
      const stylePrompt = `RÃ©Ã©cris ce texte avec style (gras, italique, emojis), sans changer le sens ni rajouter titre ou numÃ©ro :\n${lastStory}`;
      resultDiv.textContent = "âœ¨ Application du styleâ€¦";
      const res = await fetch("/ask",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:"", question:stylePrompt }) });
      const reader = res.body.getReader(); const decoder = new TextDecoder(); let styled = "";
      while (true) { const {done, value} = await reader.read(); if (done) break; styled += decoder.decode(value,{stream:true}); resultDiv.textContent = styled; }
      styled = formatStoryText(styled);
      lastStory = styled;
      const episode = document.getElementById("episode").value.trim(); const title = document.getElementById("title").value.trim(); const author = document.getElementById("author").value.trim();
      const existing = storyHistory.find(ep => ep.episode === parseInt(episode, 10));
      if (existing) {
        existing.fullText = styled;
        existing.preview = styled.slice(0,100)+"...";
        existing.content = `<h2>${title}</h2><h3>Ã‰pisode ${episode}</h3><div>${styled}</div><div class="signature">Auteur : ${author}<br>DÃ©veloppeur : Sossou KouamÃ©</div>`;
        resultDiv.innerHTML = existing.content;
      }
      renderHistory(); saveData();
    }

    // ---------- RÃ©initialiser ----------
    function resetStory() {
      if (!confirm("Voulez-vous vraiment rÃ©initialiser lâ€™histoire ?")) return;
      localStorage.removeItem("storyData");
      document.getElementById("title").value=""; document.getElementById("episode").value=""; document.getElementById("author").value=""; document.getElementById("summary").value=""; document.getElementById("consignes").value="";
      resultDiv.innerHTML=""; historyList.innerHTML=""; storyHistory=[]; lastStory="";
    }

    // ---------- Export PDF ----------
    async function exportPDF() {
      if (storyHistory.length===0) { alert("Aucune histoire Ã  exporter !"); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=30;
      const title=document.getElementById("title").value||"Mon Histoire"; const author=document.getElementById("author").value||"Inconnu"; const summary=document.getElementById("summary").value||"Pas de rÃ©sumÃ©";
      doc.setFontSize(24); doc.setTextColor(30,144,255); doc.text(title,105,y,{align:"center"}); y+=20;
      doc.setFontSize(16); doc.setTextColor(0,0,0); doc.text("Auteur : "+author,105,y,{align:"center"}); y+=20;
      doc.setFontSize(14); doc.setTextColor(80,80,80); const summaryLines=doc.splitTextToSize("RÃ©sumÃ© : "+summary,170); doc.text(summaryLines,20,y); doc.addPage();
      y=20;
      storyHistory.forEach((ep)=>{ 
        doc.setFontSize(16); doc.setTextColor(255,69,0); 
        doc.text(`Ã‰pisode ${ep.episode}`,20,y); y+=10; 
        doc.setFontSize(12); doc.setTextColor(0,0,0);
