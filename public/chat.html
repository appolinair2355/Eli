<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kouam√© AI ‚Äì G√©n√©rateur d‚Äôhistoires</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: #fff;
    }

    h1 { text-align: center; margin-bottom: 20px; }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }

    input { background: #1f1f1f; color: #fff; }
    textarea { background: #1f1f1f; color: #fff; resize: vertical; }

    #summary { height: 120px; }
    #consignes { height: 150px; }

    .btn-row {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #007bff;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }

    #minWords {
      width: 120px;
      background: #1f1f1f;
      color: #fff;
    }

    #result {
      margin-top: 20px;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 8px;
      line-height: 1.6;
    }

    #result h2, #result h3 { color: #00bfff; }
    #result strong { color: #ffcc00; }
    #result em { color: #ffaaff; }

    .signature {
      margin-top: 15px;
      font-size: 14px;
      color: #aaa;
      text-align: right;
    }

    /* Historique */
    #history {
      margin-top: 30px;
      padding: 15px;
      background: #1a1a1a;
      border-radius: 8px;
    }
    #history h2 {
      margin-top: 0;
      color: #ffcc00;
    }
    #history ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #history li {
      padding: 8px;
      margin: 5px 0;
      background: #2a2a2a;
      border-radius: 5px;
      cursor: pointer;
    }
    #history li:hover {
      background: #444;
    }

    #exportBtn {
      margin-top: 15px;
      background: #28a745;
    }
    #exportBtn:hover {
      background: #1e7e34;
    }
  </style>
</head>
<body>
  <h1>üìñ G√©n√©rateur d‚Äôhistoires ‚Äì Kouam√© AI</h1>

  <!-- Ligne titre / √©pisode / auteur -->
  <div class="form-row">
    <input id="title" type="text" placeholder="Titre de l‚Äôhistoire">
    <input id="episode" type="number" placeholder="√âpisode">
    <input id="author" type="text" placeholder="Auteur">
  </div>

  <!-- R√©sum√© initial -->
  <label for="summary">R√©sum√© de base (pr√©sentation des personnages et contexte) :</label>
  <textarea id="summary" placeholder="D√©crivez vos personnages, univers et contexte de d√©part..."></textarea>

  <!-- Zone de consignes -->
  <label for="consignes">Consignes / Modifications :</label>
  <textarea id="consignes" placeholder="√âcrivez vos consignes ou modifications ici..."></textarea>

  <!-- Ligne boutons -->
  <div class="btn-row">
    <button onclick="generateStory()">Ai Kouam√© g√©n√©r√©</button>
    <input id="minWords" type="number" placeholder="N (mots min)">
    <button onclick="nextEpisode()">√âpisode suivant</button>
    <button onclick="styleStory()">S</button>
    <button onclick="resetStory()" style="background:#dc3545;">üîÑ R√©initialiser</button>
  </div>

  <!-- R√©sultat -->
  <div id="result"></div>

  <!-- Historique -->
  <div id="history">
    <h2>üìö Historique des √©pisodes</h2>
    <ul id="historyList"></ul>
    <button id="exportBtn" onclick="exportPDF()">üì• Exporter en PDF</button>
  </div>

  <script>
    const resultDiv = document.getElementById("result");
    const historyList = document.getElementById("historyList");
    let lastStory = ""; 
    let storyHistory = []; 
    let firstEpisodeGenerated = false;

    // ---------- Sauvegarde automatique ----------
    function saveData() {
      const data = {
        title: document.getElementById("title").value,
        episode: document.getElementById("episode").value,
        author: document.getElementById("author").value,
        summary: document.getElementById("summary").value,
        consignes: document.getElementById("consignes").value,
        history: storyHistory,
        result: resultDiv.innerHTML,
        locked: firstEpisodeGenerated
      };
      localStorage.setItem("storyData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("storyData");
      if (!saved) return;
      const data = JSON.parse(saved);
      document.getElementById("title").value = data.title || "";
      document.getElementById("episode").value = data.episode || "";
      document.getElementById("author").value = data.author || "";
      document.getElementById("summary").value = data.summary || "";
      document.getElementById("consignes").value = data.consignes || "";
      storyHistory = data.history || [];
      resultDiv.innerHTML = data.result || "";
      firstEpisodeGenerated = data.locked || false;

      if (firstEpisodeGenerated) {
        document.getElementById("summary").readOnly = true;
      }
      renderHistory();
    }

    window.onload = loadData;
    window.onbeforeunload = saveData;

    // ---------- Historique ----------
    function renderHistory() {
      historyList.innerHTML = "";
      storyHistory.forEach((ep, index) => {
        const li = document.createElement("li");
        li.textContent = ep.title + " ‚Äì " + ep.episode + " : " + ep.preview;
        li.onclick = () => {
          resultDiv.innerHTML = ep.content;
          lastStory = ep.fullText;
        };
        historyList.appendChild(li);
      });
    }

    // ---------- G√©n√©ration ----------
    async function generateStory() {
      const title = document.getElementById("title").value.trim();
      const episode = document.getElementById("episode").value.trim();
      const author = document.getElementById("author").value.trim();
      const summary = document.getElementById("summary").value.trim();
      const consignes = document.getElementById("consignes").value.trim();
      const minWords = document.getElementById("minWords").value.trim();

      if (!title || !episode || !author || !summary) {
        alert("Veuillez remplir Titre, √âpisode, Auteur et R√©sum√© !");
        return;
      }

      let context = `Titre de l‚Äôhistoire : ${title}\n√âpisode ${episode}\nAuteur : ${author}\n\nR√©sum√© de base (contexte et personnages) :\n${summary}\n\n`;

      if (storyHistory.length > 0) {
        context += `R√©sum√© des √©pisodes pr√©c√©dents :\n${storyHistory.map(e => `√âpisode ${e.episode} : ${e.preview}`).join("\n")}\n\n`;
      }

      if (consignes.toLowerCase().includes("conclusion")) {
        context += "‚ö†Ô∏è G√©n√®re la conclusion finale de cette histoire, fid√®le au titre et aux personnages, avec une morale.\n";
      } else {
        context += `Consignes actuelles : ${consignes}\n`;
      }

      if (minWords) {
        context += `‚ö†Ô∏è Le texte doit contenir au minimum ${minWords} mots.\n`;
      }

      context += `
‚ö†Ô∏è R√®gles imp√©ratives :
- L‚Äôhistoire doit toujours rester dans le cadre du titre **"${title}"**.
- Les personnages et √©v√©nements doivent rester coh√©rents.
- Ne jamais inventer un univers ou des personnages hors sujet.
- Chaque √©pisode doit √™tre une suite logique de l‚Äôhistoire.
- Style narratif riche avec :
   ‚Ä¢ **gras** pour moments importants  
   ‚Ä¢ *italique* pour dialogues/pens√©es  
   ‚Ä¢ üé≠üî•‚ú®‚ù§Ô∏è emojis pour √©motions et ambiance  
   ‚Ä¢ paragraphes clairs
`;

      resultDiv.textContent = "‚è≥ Kouam√© AI r√©fl√©chit‚Ä¶";

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: "", question: context })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let story = "";
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        story += decoder.decode(value, { stream: true });
        resultDiv.textContent = story;
      }

      lastStory = story;

      const fullContent = `<h2>${title}</h2>
        <h3>√âpisode ${episode}</h3>
        <div>${story}</div>
        <div class="signature">Auteur : ${author}<br>D√©veloppeur : Sossou Kouam√©</div>`;

      resultDiv.innerHTML = fullContent;

      storyHistory.push({
        title,
        episode,
        preview: story.slice(0, 100) + "...",
        content: fullContent,
        fullText: story
      });

      if (!firstEpisodeGenerated) {
        document.getElementById("summary").readOnly = true;
        firstEpisodeGenerated = true;
      }

      renderHistory();
      saveData();
    }

    async function nextEpisode() {
      const epInput = document.getElementById("episode");
      epInput.value = parseInt(epInput.value || "0") + 1;
      await generateStory();
    }

    async function styleStory() {
      if (!lastStory) {
        alert("G√©n√©rez d‚Äôabord une histoire !");
        return;
      }

      const stylePrompt = `R√©√©cris ce texte en gardant strictement le cadre du titre et des personnages, mais rends-le plus immersif avec du Markdown (gras, italique, emojis) :\n${lastStory}`;
      resultDiv.textContent = "‚ú® Application du style‚Ä¶";

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: "", question: stylePrompt })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let styled = "";
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        styled += decoder.decode(value, { stream: true });
        resultDiv.textContent = styled;
      }

      lastStory = styled;
      saveData();
    }

    // ---------- R√©initialiser ----------
    function resetStory() {
      if (!confirm("Voulez-vous vraiment r√©initialiser l‚Äôhistoire ?")) return;

      localStorage.removeItem("storyData");
      document.getElementById("title").value = "";
      document.getElementById("episode").value = "";
      document.getElementById("author").value = "";
      document.getElementById("summary").value = "";
      document.getElementById("consignes").value = "";
      document.getElementById("summary").readOnly = false;
      resultDiv.innerHTML = "";
      historyList.innerHTML = "";
      storyHistory = [];
      lastStory = "";
      firstEpisodeGenerated = false;
    }

    // ---------- Export PDF avec page de garde ----------
    async function exportPDF() {
      if (storyHistory.length === 0) {
        alert("Aucune histoire √† exporter !");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 30;

      const title = document.getElementById("title").value || "Mon Histoire";
      const author = document.getElementById("author").value || "Inconnu";
      const summary = document.getElementById("summary").value || "Pas de r√©sum√©";

      // üé® Page de garde
      doc.setFontSize(24);
      doc.setTextColor(30, 144, 255);
      doc.text(title, 105, y, { align: "center" });
      y += 20;

      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text("Auteur : " + author, 105, y, { align: "center" });
      y += 20;

      doc.setFontSize(14);
      doc.setTextColor(80, 80, 80);
      const summaryLines = doc.splitTextToSize("R√©sum√© : " + summary, 170);
      doc.text(summaryLines, 20, y);
      doc.addPage();

      // üìö Episodes
      y = 20;
      storyHistory.forEach((ep, index) => {
        doc.setFontSize(16);
        doc.setTextColor(255, 69, 0);
        doc.text(`√âpisode ${ep.episode}`, 20, y);
        y += 10;

        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const lines = doc.splitTextToSize(ep.fullText, 170);
        lines.forEach(line => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text(line, 20, y, { align: "justify" });
          y += 7;
        });

        y += 5;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, y, 190, y);
        y += 10;
      });

      // Signature
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text("D√©veloppeur : Sossou Kouam√©", 105, 290, { align: "center" });

      doc.save(`${title}.pdf`);
    }
  </script>
</body>
    </html>
